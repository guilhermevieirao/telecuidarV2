<div class="invites">
  <div class="invites__header">
    <div class="invites__header-content">
      <app-icon name="mail" [size]="32" />
      <div>
        <h1 class="invites__title">Convites</h1>
        <p class="invites__subtitle">Gerencie os convites de cadastro enviados</p>
      </div>
    </div>
    <button
      type="button"
      class="invites__create-btn"
      (click)="openCreateModal()"
    >
      <app-icon name="plus" [size]="20" />
      Novo Convite
    </button>
  </div>

  <div class="invites__filters">
    <app-search-input
      [(ngModel)]="searchTerm"
      (ngModelChange)="onSearchChange()"
      (search)="onSearch($event)"
      placeholder="Buscar por email, ID ou criador..."
      icon="search"
    />

    <app-filter-select
      [(ngModel)]="roleFilter"
      (change)="onFilterChange()"
      [options]="roleOptions"
    />

    <app-filter-select
      [(ngModel)]="statusFilter"
      (change)="onFilterChange()"
      [options]="statusOptions"
    />
  </div>

  @if (isLoading) {
    <div class="invites__loading">
      <p>Carregando convites...</p>
    </div>
  } @else {
    <div class="invites__table-wrapper">
      <table class="invites-table">
        <thead class="invites-table__head">
          <tr>
            <th class="invites-table__header invites-table__header--sortable">
              <app-table-header
                label="ID"
                field="id"
                [sortable]="true"
                [currentSortField]="sortField"
                [currentSortDirection]="sortDirection"
                (sort)="sort($event)"
              />
            </th>
            <th class="invites-table__header invites-table__header--sortable">
              <app-table-header
                label="EMAIL"
                field="email"
                [sortable]="true"
                [currentSortField]="sortField"
                [currentSortDirection]="sortDirection"
                (sort)="sort($event)"
              />
            </th>
            <th class="invites-table__header">NOME PRÉ-PREENCHIDO</th>
            <th class="invites-table__header invites-table__header--sortable">
              <app-table-header
                label="PERFIL"
                field="role"
                [sortable]="true"
                [currentSortField]="sortField"
                [currentSortDirection]="sortDirection"
                (sort)="sort($event)"
              />
            </th>
            <th class="invites-table__header invites-table__header--sortable">
              <app-table-header
                label="STATUS"
                field="status"
                [sortable]="true"
                [currentSortField]="sortField"
                [currentSortDirection]="sortDirection"
                (sort)="sort($event)"
              />
            </th>
            <th class="invites-table__header invites-table__header--sortable">
              <app-table-header
                label="CRIADO EM"
                field="createdAt"
                [sortable]="true"
                [currentSortField]="sortField"
                [currentSortDirection]="sortDirection"
                (sort)="sort($event)"
              />
            </th>
            <th class="invites-table__header invites-table__header--sortable">
              <app-table-header
                label="EXPIRA EM"
                field="expiresAt"
                [sortable]="true"
                [currentSortField]="sortField"
                [currentSortDirection]="sortDirection"
                (sort)="sort($event)"
              />
            </th>
            <th class="invites-table__header invites-table__header--actions">AÇÕES</th>
          </tr>
        </thead>
        <tbody class="invites-table__body">
          @if (invites.length === 0) {
            <tr>
              <td colspan="8" class="invites-table__empty-cell">
                <div class="invites__empty">
                  <app-icon name="mail" [size]="48" />
                  <p>Nenhum convite encontrado</p>
                </div>
              </td>
            </tr>
          } @else {
            @for (invite of invites; track invite.id) {
            <tr class="invites-table__row">
              <td class="invites-table__cell">
                <span class="invites-table__id">#{{ invite.id }}</span>
              </td>
              <td class="invites-table__cell">
                <div class="invites-table__email">
                  <span class="invites-table__email-text">{{ invite.email || '-' }}</span>
                  <span class="invites-table__created-by">por {{ invite.createdByUserName || 'Sistema' }}</span>
                </div>
              </td>
              <td class="invites-table__cell">
                @if (invite.prefilledName || invite.prefilledLastName) {
                  <div class="invites-table__prefilled">
                    <span class="invites-table__prefilled-text">{{ invite.prefilledName }} {{ invite.prefilledLastName }}</span>
                    @if (invite.prefilledCpf || invite.prefilledPhone) {
                      <span class="invites-table__prefilled-details">
                        @if (invite.prefilledCpf) { CPF: {{ invite.prefilledCpf }} }
                        @if (invite.prefilledPhone) { Tel: {{ invite.prefilledPhone }} }
                      </span>
                    }
                  </div>
                } @else {
                  <span class="invites-table__empty-data">-</span>
                }
              </td>
              <td class="invites-table__cell">
                <app-badge
                  [variant]="getRoleBadgeVariant(invite.role)"
                  [label]="getRoleLabel(invite.role)"
                  size="sm"
                />
              </td>
              <td class="invites-table__cell">
                <app-badge
                  [variant]="getStatusBadgeVariant(invite.status)"
                  [label]="getStatusLabel(invite.status)"
                  size="sm"
                />
              </td>
              <td class="invites-table__cell">
                <div class="invites-table__date">
                  {{ invite.createdAt | date:'dd/MM/yyyy' }}
                  <span class="invites-table__time">{{ invite.createdAt | date:'HH:mm' }}</span>
                </div>
              </td>
              <td class="invites-table__cell">
                <div class="invites-table__date" [class.invites-table__date--expired]="isExpired(invite)">
                  {{ invite.expiresAt | date:'dd/MM/yyyy' }}
                  <span class="invites-table__time">{{ invite.expiresAt | date:'HH:mm' }}</span>
                </div>
              </td>
              <td class="invites-table__cell invites-table__cell--actions">
                <div class="invites-table__actions">
                  @if (invite.status === 'Pending') {
                    <button
                      type="button"
                      class="invites-table__action-btn"
                      (click)="getInviteByToken(invite)"
                      title="Copiar link do convite"
                    >
                      <app-icon name="file" [size]="18" />
                    </button>
                    <button
                      type="button"
                      class="invites-table__action-btn"
                      (click)="resendInvite(invite)"
                      title="Reenviar convite"
                    >
                      <app-icon name="mail" [size]="18" />
                    </button>
                    <button
                      type="button"
                      class="invites-table__action-btn invites-table__action-btn--warning"
                      (click)="cancelInvite(invite)"
                      title="Cancelar convite"
                    >
                      <app-icon name="close" [size]="18" />
                    </button>
                  }
                  <button
                    type="button"
                    class="invites-table__action-btn invites-table__action-btn--delete"
                    (click)="deleteInvite(invite)"
                    title="Excluir convite"
                  >
                    <app-icon name="trash" [size]="18" />
                  </button>
                </div>
              </td>
            </tr>
            }
          }
        </tbody>
      </table>
    </div>

    <app-pagination
      [currentPage]="currentPage"
      [totalPages]="totalPages"
      [pageSize]="pageSize"
      [total]="totalInvites"
      (pageChange)="onPageChange($event)"
      (pageSizeChange)="onPageSizeChange($event)"
    />
  }
</div>

<app-invite-create-modal
  [isOpen]="isCreateModalOpen"
  (close)="closeCreateModal()"
  (create)="handleCreateInvite($event)"
/>
