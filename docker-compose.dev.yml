# ========================================
# TeleCuidar - Docker Compose (Desenvolvimento Local com Docker)
# Inclui Backend, Frontend, Nginx e Jitsi Self-Hosted
# ========================================
# Comando: docker compose -f docker-compose.dev.yml up --build -d
# ========================================

services:
  # ----------------------------------------
  # NGINX - Proxy Reverso (Dev)
  # ----------------------------------------
  nginx:
    image: nginx:alpine
    container_name: telecuidar-nginx-dev
    restart: unless-stopped
    ports:
      - "80:80"
    volumes:
      - ./docker/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./docker/nginx/conf.d/default.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      - backend
      - frontend
    networks:
      - telecuidar-dev
    healthcheck:
      test: ["CMD", "nginx", "-t"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ----------------------------------------
  # BACKEND - .NET 10 API
  # ----------------------------------------
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: telecuidar-backend-dev
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:5000
      - DB_CONNECTION_STRING=Data Source=/app/data/telecuidar.db
      - JWT_SECRET_KEY=TelecuidarDevSecretKey2024SuperSecureKeyForDevelopmentEnvironment!@#$%^&*()_+
      - JWT_ISSUER=TelecuidarAPI
      - JWT_AUDIENCE=TelecuidarClient
      - CORS_ALLOWED_ORIGINS=http://localhost,http://localhost:4200,http://localhost:80
      - SEED_DATA_ENABLED=true
      - SWAGGER_ENABLED=true
      # Jitsi Self-Hosted (Dev)
      - JITSI_ENABLED=true
      - JITSI_DOMAIN=localhost:8443
      - JITSI_APP_ID=telecuidar
      - JITSI_APP_SECRET=TelecuidarJitsiSecretKey2024LocalDevelopment!@#$%^&*()
      - JITSI_REQUIRES_AUTH=true
    volumes:
      - ./data:/app/data
      - ./uploads:/app/uploads
    expose:
      - "5000"
    networks:
      - telecuidar-dev
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:5000/health || exit 1"]
      interval: 30s
      timeout: 10s
      start_period: 30s
      retries: 3

  # ----------------------------------------
  # FRONTEND - Angular 21 SSR
  # ----------------------------------------
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: telecuidar-frontend-dev
    environment:
      - NODE_ENV=development
      - PORT=4000
    expose:
      - "4000"
    networks:
      - telecuidar-dev
    depends_on:
      - backend
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:4000"]
      interval: 30s
      timeout: 10s
      start_period: 30s
      retries: 3

  # ========================================
  # JITSI MEET - VIDEOCHAMADAS SELF-HOSTED
  # ========================================
  
  # ----------------------------------------
  # JITSI WEB - Interface Web
  # ----------------------------------------
  jitsi-web:
    image: jitsi/web:stable-9753
    container_name: telecuidar-jitsi-web-dev
    restart: unless-stopped
    ports:
      - "8443:443"
    environment:
      - ENABLE_AUTH=1
      - ENABLE_GUESTS=0
      - ENABLE_XMPP_WEBSOCKET=1
      - ENABLE_COLIBRI_WEBSOCKET=1
      - ENABLE_RECORDING=0
      - ENABLE_LIVESTREAMING=0
      - ENABLE_TRANSCRIPTIONS=0
      - DISABLE_HTTPS=0
      - ENABLE_LETSENCRYPT=0
      - JICOFO_AUTH_USER=focus
      - PUBLIC_URL=https://localhost:8443
      - TZ=America/Sao_Paulo
      - XMPP_AUTH_DOMAIN=auth.meet.jitsi
      - XMPP_BOSH_URL_BASE=http://prosody:5280
      - XMPP_DOMAIN=meet.jitsi
      - XMPP_GUEST_DOMAIN=guest.meet.jitsi
      - XMPP_MUC_DOMAIN=muc.meet.jitsi
      - XMPP_INTERNAL_MUC_DOMAIN=internal-muc.meet.jitsi
    volumes:
      - jitsi-web-config:/config
      - jitsi-web-certs:/etc/letsencrypt
      - jitsi-transcripts:/usr/share/jitsi-meet/transcripts
    networks:
      meet.jitsi:
        aliases:
          - meet.jitsi

  # ----------------------------------------
  # PROSODY - Servidor XMPP
  # ----------------------------------------
  prosody:
    image: jitsi/prosody:stable-9753
    container_name: telecuidar-prosody-dev
    restart: unless-stopped
    expose:
      - "5222"
      - "5347"
      - "5280"
    environment:
      - AUTH_TYPE=jwt
      - ENABLE_AUTH=1
      - ENABLE_GUESTS=0
      - ENABLE_LOBBY=1
      - ENABLE_XMPP_WEBSOCKET=1
      - LOG_LEVEL=info
      - XMPP_AUTH_DOMAIN=auth.meet.jitsi
      - XMPP_DOMAIN=meet.jitsi
      - XMPP_GUEST_DOMAIN=guest.meet.jitsi
      - XMPP_MUC_DOMAIN=muc.meet.jitsi
      - XMPP_INTERNAL_MUC_DOMAIN=internal-muc.meet.jitsi
      - XMPP_RECORDER_DOMAIN=recorder.meet.jitsi
      - JICOFO_AUTH_USER=focus
      - JICOFO_AUTH_PASSWORD=s3cr3tjicofo
      - JICOFO_COMPONENT_SECRET=s3cr3tcomponent
      - JVB_AUTH_USER=jvb
      - JVB_AUTH_PASSWORD=s3cr3tjvb
      - JWT_APP_ID=telecuidar
      - JWT_APP_SECRET=TelecuidarJitsiSecretKey2024LocalDevelopment!@#$%^&*()
      - JWT_ACCEPTED_ISSUERS=telecuidar
      - JWT_ACCEPTED_AUDIENCES=telecuidar
      - JWT_ALLOW_EMPTY=0
      - JWT_AUTH_TYPE=token
      - JWT_TOKEN_AUTH_MODULE=token_verification
      - PUBLIC_URL=https://localhost:8443
      - TZ=America/Sao_Paulo
    volumes:
      - jitsi-prosody-config:/config
      - jitsi-prosody-plugins:/prosody-plugins-custom
    networks:
      meet.jitsi:
        aliases:
          - prosody
          - xmpp.meet.jitsi

  # ----------------------------------------
  # JICOFO - Jitsi Conference Focus
  # ----------------------------------------
  jicofo:
    image: jitsi/jicofo:stable-9753
    container_name: telecuidar-jicofo-dev
    restart: unless-stopped
    environment:
      - AUTH_TYPE=jwt
      - ENABLE_AUTH=1
      - XMPP_AUTH_DOMAIN=auth.meet.jitsi
      - XMPP_DOMAIN=meet.jitsi
      - XMPP_INTERNAL_MUC_DOMAIN=internal-muc.meet.jitsi
      - XMPP_MUC_DOMAIN=muc.meet.jitsi
      - XMPP_SERVER=prosody
      - JICOFO_AUTH_USER=focus
      - JICOFO_AUTH_PASSWORD=s3cr3tjicofo
      - JICOFO_COMPONENT_SECRET=s3cr3tcomponent
      - TZ=America/Sao_Paulo
      - JICOFO_ENABLE_HEALTH_CHECKS=true
    depends_on:
      - prosody
    volumes:
      - jitsi-jicofo-config:/config
    networks:
      meet.jitsi:

  # ----------------------------------------
  # JVB - Jitsi Videobridge
  # ----------------------------------------
  jvb:
    image: jitsi/jvb:stable-9753
    container_name: telecuidar-jvb-dev
    restart: unless-stopped
    ports:
      - "10000:10000/udp"
    environment:
      - XMPP_AUTH_DOMAIN=auth.meet.jitsi
      - XMPP_INTERNAL_MUC_DOMAIN=internal-muc.meet.jitsi
      - XMPP_SERVER=prosody
      - JVB_AUTH_USER=jvb
      - JVB_AUTH_PASSWORD=s3cr3tjvb
      - JVB_BREWERY_MUC=jvbbrewery
      - JVB_PORT=10000
      - JVB_TCP_HARVESTER_DISABLED=true
      - JVB_STUN_SERVERS=meet-jit-si-turnrelay.jitsi.net:443
      - JVB_ENABLE_APIS=rest,colibri
      - PUBLIC_URL=https://localhost:8443
      - COLIBRI_REST_ENABLED=true
      - SHUTDOWN_REST_ENABLED=true
      - TZ=America/Sao_Paulo
    depends_on:
      - prosody
    volumes:
      - jitsi-jvb-config:/config
    networks:
      meet.jitsi:

# ----------------------------------------
# VOLUMES
# ----------------------------------------
volumes:
  jitsi-web-config:
  jitsi-web-certs:
  jitsi-transcripts:
  jitsi-prosody-config:
  jitsi-prosody-plugins:
  jitsi-jicofo-config:
  jitsi-jvb-config:

# ----------------------------------------
# REDES
# ----------------------------------------
networks:
  telecuidar-dev:
    driver: bridge
  meet.jitsi:
    driver: bridge

